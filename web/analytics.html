<!DOCTYPE html>
<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>UPAO - Grupo 1 - IoT - Analytics</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&amp;display=swap" rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <style>
        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }
    </style>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#2b7cee",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101822",
                    },
                    fontFamily: {
                        "display": ["Manrope"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
</head>

<body class="font-display bg-background-light dark:bg-background-dark">
    <div class="relative flex h-auto min-h-screen w-full flex-col group/design-root overflow-x-hidden">
        <div class="flex min-h-screen">
            <aside
                class="w-64 shrink-0 flex-col justify-between bg-white dark:bg-[#182330] p-4 hidden lg:flex border-r border-slate-200 dark:border-slate-800">
                <div class="flex flex-col gap-4">
                    <div class="flex items-center gap-3 p-2">
                        <div class="flex flex-col">
                            <h1 class="text-slate-900 dark:text-slate-200 text-base font-medium leading-normal">UPAO IoT
                            </h1>
                            <p class="text-slate-500 dark:text-slate-400 text-sm font-normal leading-normal">Grupo 1</p>
                        </div>
                    </div>
                    <nav class="flex flex-col gap-2 mt-4">
                        <a class="flex items-center gap-3 px-3 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800"
                            href="index.html">
                            <span class="material-symbols-outlined">dashboard</span>
                            <p class="text-sm font-medium leading-normal">Dashboard</p>
                        </a>
                        <a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/10 text-primary dark:bg-primary/20"
                            href="#">
                            <span class="material-symbols-outlined"
                                style="font-variation-settings: 'FILL' 1;">bar_chart</span>
                            <p class="text-sm font-medium leading-normal">Analytics</p>
                        </a>
                    </nav>
                </div>
            </aside>
            <main class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto">
                <div class="mx-auto max-w-7xl">
                    <div class="flex flex-wrap justify-between gap-3 p-4">
                        <div class="flex min-w-72 flex-col gap-2">
                            <p
                                class="text-[#0d131b] dark:text-slate-100 text-3xl md:text-4xl font-black leading-tight tracking-[-0.033em]">
                                Analytics – IoT Classification Line</p>
                            <!DOCTYPE html>
                            <html class="light" lang="en">

                            <head>
                                <meta charset="utf-8" />
                                <meta content="width=device-width, initial-scale=1.0" name="viewport" />
                                <title>UPAO - Grupo 1 - IoT - Analytics</title>
                                <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
                                <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
                                <link href="https://fonts.googleapis.com" rel="preconnect" />
                                <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
                                <link
                                    href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&amp;display=swap"
                                    rel="stylesheet" />
                                <link
                                    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
                                    rel="stylesheet" />
                                <style>
                                    .material-symbols-outlined {
                                        font-variation-settings:
                                            'FILL' 0,
                                            'wght' 400,
                                            'GRAD' 0,
                                            'opsz' 24
                                    }
                                </style>
                                <script id="tailwind-config">
                                    tailwind.config = {
                                        darkMode: "class",
                                        theme: {
                                            extend: {
                                                colors: {
                                                    "primary": "#2b7cee",
                                                    "background-light": "#f6f7f8",
                                                    "background-dark": "#101822",
                                                },
                                                fontFamily: {
                                                    "display": ["Manrope"]
                                                },
                                                borderRadius: {
                                                    "DEFAULT": "0.25rem",
                                                    "lg": "0.5rem",
                                                    "xl": "0.75rem",
                                                    "full": "9999px"
                                                },
                                            },
                                        },
                                    }
                                </script>
                            </head>

                            <body class="font-display bg-background-light dark:bg-background-dark">
                                <div
                                    class="relative flex h-auto min-h-screen w-full flex-col group/design-root overflow-x-hidden">
                                    <div class="flex min-h-screen">
                                        <aside
                                            class="w-64 shrink-0 flex-col justify-between bg-white dark:bg-[#182330] p-4 hidden lg:flex border-r border-slate-200 dark:border-slate-800">
                                            <div class="flex flex-col gap-4">
                                                <div class="flex items-center gap-3 p-2">
                                                    <div class="flex flex-col">
                                                        <h1
                                                            class="text-slate-900 dark:text-slate-200 text-base font-medium leading-normal">
                                                            UPAO IoT
                                                        </h1>
                                                        <p
                                                            class="text-slate-500 dark:text-slate-400 text-sm font-normal leading-normal">
                                                            Grupo 1</p>
                                                    </div>
                                                </div>
                                                <nav class="flex flex-col gap-2 mt-4">
                                                    <a class="flex items-center gap-3 px-3 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800"
                                                        href="index.html">
                                                        <span class="material-symbols-outlined">dashboard</span>
                                                        <p class="text-sm font-medium leading-normal">Dashboard</p>
                                                    </a>
                                                    <a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/10 text-primary dark:bg-primary/20"
                                                        href="#">
                                                        <span class="material-symbols-outlined"
                                                            style="font-variation-settings: 'FILL' 1;">bar_chart</span>
                                                        <p class="text-sm font-medium leading-normal">Analytics</p>
                                                    </a>
                                                </nav>
                                            </div>
                                        </aside>
                                        <main class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto">
                                            <div class="mx-auto max-w-7xl">
                                                <div class="flex flex-wrap justify-between gap-3 p-4">
                                                    <div class="flex min-w-72 flex-col gap-2">
                                                        <p
                                                            class="text-[#0d131b] dark:text-slate-100 text-3xl md:text-4xl font-black leading-tight tracking-[-0.033em]">
                                                            Analytics – IoT Classification Line</p>
                                                        <p
                                                            class="text-[#4c6c9a] dark:text-slate-400 text-base font-normal leading-normal">
                                                            Real-time
                                                            and historical overview of the product color classification
                                                            system.</p>
                                                    </div>
                                                </div>
                                                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

                                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 p-4">
                                                    <div
                                                        class="flex flex-1 flex-col gap-2 rounded-xl p-6 border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#182330]">
                                                        <p
                                                            class="text-slate-600 dark:text-slate-300 text-base font-medium leading-normal">
                                                            Total
                                                            Products Processed</p>
                                                        <p id="total-products"
                                                            class="text-[#0d131b] dark:text-slate-100 tracking-tight text-3xl font-bold leading-tight">
                                                            0</p>
                                                    </div>
                                                    <div
                                                        class="flex flex-1 flex-col gap-2 rounded-xl p-6 border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#182330]">
                                                        <p
                                                            class="text-slate-600 dark:text-slate-300 text-base font-medium leading-normal">
                                                            Red
                                                            Products</p>
                                                        <p id="total-red"
                                                            class="text-[#0d131b] dark:text-slate-100 tracking-tight text-3xl font-bold leading-tight">
                                                            0</p>
                                                    </div>
                                                    <div
                                                        class="flex flex-1 flex-col gap-2 rounded-xl p-6 border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#182330]">
                                                        <p
                                                            class="text-slate-600 dark:text-slate-300 text-base font-medium leading-normal">
                                                            Green
                                                            Products</p>
                                                        <p id="total-green"
                                                            class="text-[#0d131b] dark:text-slate-100 tracking-tight text-3xl font-bold leading-tight">
                                                            0</p>
                                                    </div>
                                                    <div
                                                        class="flex flex-1 flex-col gap-2 rounded-xl p-6 border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#182330]">
                                                        <p
                                                            class="text-slate-600 dark:text-slate-300 text-base font-medium leading-normal">
                                                            Blue
                                                            Products</p>
                                                        <p id="total-blue"
                                                            class="text-[#0d131b] dark:text-slate-100 tracking-tight text-3xl font-bold leading-tight">
                                                            0</p>
                                                    </div>
                                                </div>

                                                <div class="grid grid-cols-1 xl:grid-cols-3 gap-4 px-4">
                                                    <div
                                                        class="xl:col-span-2 p-6 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#182330]">
                                                        <h3
                                                            class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">
                                                            Production Volume (Last 20 Detections)</h3>
                                                        <div
                                                            class="h-80 flex items-center justify-center relative w-full">
                                                            <canvas id="volumeChart"></canvas>
                                                        </div>
                                                    </div>
                                                    <div
                                                        class="p-6 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#182330]">
                                                        <h3
                                                            class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">
                                                            Overall Color Breakdown</h3>
                                                        <div
                                                            class="h-80 flex items-center justify-center relative w-full">
                                                            <canvas id="breakdownChart"></canvas>
                                                        </div>
                                                    </div>
                                                    <div
                                                        class="xl:col-span-3 p-6 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#182330]">
                                                        <h3
                                                            class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">
                                                            Color Distribution by Shift</h3>
                                                        <div
                                                            class="h-80 flex items-center justify-center relative w-full">
                                                            <canvas id="shiftChart"></canvas>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="px-4 pt-8 pb-4">
                                                    <div
                                                        class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#182330] overflow-hidden">
                                                        <h3
                                                            class="text-lg font-semibold text-slate-800 dark:text-slate-200 p-6">
                                                            Complete Production
                                                            Log</h3>
                                                        <div class="overflow-x-auto">
                                                            <table
                                                                class="w-full text-sm text-left text-slate-500 dark:text-slate-400">
                                                                <thead
                                                                    class="text-xs text-slate-700 dark:text-slate-300 uppercase bg-slate-50 dark:bg-slate-800/50">
                                                                    <tr>
                                                                        <th class="px-6 py-3" scope="col">Color</th>
                                                                        <th class="px-6 py-3" scope="col">Shift</th>
                                                                        <th class="px-6 py-3" scope="col">Time</th>
                                                                        <th class="px-6 py-3" scope="col">Day</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody id="log-table-body">
                                                                    <!-- Rows injected via JS -->
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </main>
                                    </div>
                                </div>

                                <script>
                                    // --- Supabase Config ---
                                    const SUPABASE_URL = 'https://evorufjkfqmqmjhdpxeo.supabase.co';
                                    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2b3J1ZmprZnFtcW1qaGRweGVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3Njc1NTgsImV4cCI6MjA3OTM0MzU1OH0.ewTwn9B7cj_5ibr12UiMxxhd0sM5CTRfCF4IiepCJrI';
                                    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

                                    const totalProductsEl = document.getElementById('total-products');
                                    const totalRedEl = document.getElementById('total-red');
                                    const totalGreenEl = document.getElementById('total-green');
                                    const totalBlueEl = document.getElementById('total-blue');
                                    const logTableBody = document.getElementById('log-table-body');

                                    // Chart Instances
                                    let volumeChart, breakdownChart, shiftChart;

                                    async function init() {
                                        await fetchTotalsAndRenderCharts();
                                        fetchLog();

                                        // Subscribe to updates
                                        supabaseClient.channel('public:turnos')
                                            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'turnos' }, fetchTotalsAndRenderCharts)
                                            .subscribe();

                                        supabaseClient.channel('public:lecturas')
                                            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'lecturas' }, payload => {
                                                addLogRow(payload.new);
                                                fetchTotalsAndRenderCharts();
                                            })
                                            .subscribe();
                                    }

                                    async function fetchTotalsAndRenderCharts() {
                                        const { data: turnosData } = await supabaseClient.from('turnos').select('*');
                                        const { data: lecturasData } = await supabaseClient.from('lecturas').select('created_at').order('created_at', { ascending: false }).limit(50);

                                        if (turnosData) {
                                            let r = 0, g = 0, b = 0;
                                            let shiftData = {
                                                labels: [],
                                                rojo: [],
                                                verde: [],
                                                azul: []
                                            };

                                            turnosData.forEach(row => {
                                                r += row.rojo;
                                                g += row.verde;
                                                b += row.azul;

                                                shiftData.labels.push(row.turno);
                                                shiftData.rojo.push(row.rojo);
                                                shiftData.verde.push(row.verde);
                                                shiftData.azul.push(row.azul);
                                            });

                                            totalRedEl.textContent = r;
                                            totalGreenEl.textContent = g;
                                            totalBlueEl.textContent = b;
                                            totalProductsEl.textContent = r + g + b;

                                            renderBreakdownChart(r, g, b);
                                            renderShiftChart(shiftData);
                                        }

                                        if (lecturasData) {
                                            renderVolumeChart(lecturasData);
                                        }
                                    }

                                    function renderBreakdownChart(r, g, b) {
                                        const ctx = document.getElementById('breakdownChart').getContext('2d');
                                        if (breakdownChart) breakdownChart.destroy();

                                        breakdownChart = new Chart(ctx, {
                                            type: 'doughnut',
                                            data: {
                                                labels: ['Rojo', 'Verde', 'Azul'],
                                                datasets: [{
                                                    data: [r, g, b],
                                                    backgroundColor: ['#D90429', '#00A878', '#3A86FF'],
                                                    borderWidth: 0
                                                }]
                                            },
                                            options: {
                                                responsive: true,
                                                maintainAspectRatio: false,
                                                plugins: {
                                                    legend: { position: 'bottom', labels: { color: '#94a3b8' } }
                                                }
                                            }
                                        });
                                    }

                                    function renderShiftChart(data) {
                                        const ctx = document.getElementById('shiftChart').getContext('2d');
                                        if (shiftChart) shiftChart.destroy();

                                        shiftChart = new Chart(ctx, {
                                            type: 'bar',
                                            data: {
                                                labels: data.labels,
                                                datasets: [
                                                    { label: 'Rojo', data: data.rojo, backgroundColor: '#D90429' },
                                                    { label: 'Verde', data: data.verde, backgroundColor: '#00A878' },
                                                    { label: 'Azul', data: data.azul, backgroundColor: '#3A86FF' }
                                                ]
                                            },
                                            options: {
                                                responsive: true,
                                                maintainAspectRatio: false,
                                                scales: {
                                                    y: { beginAtZero: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                                                    x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                                                },
                                                plugins: {
                                                    legend: { labels: { color: '#94a3b8' } }
                                                }
                                            }
                                        });
                                    }

                                    function renderVolumeChart(data) {
                                        // Simple aggregation: Count detections per minute for the last few entries
                                        // Since we only fetch last 50, let's just show a timeline of when they happened
                                        // Or better, group by minute.

                                        const countsByTime = {};
                                        data.forEach(d => {
                                            const time = new Date(d.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                                            countsByTime[time] = (countsByTime[time] || 0) + 1;
                                        });

                                        const labels = Object.keys(countsByTime).reverse();
                                        const values = Object.values(countsByTime).reverse();

                                        const ctx = document.getElementById('volumeChart').getContext('2d');
                                        if (volumeChart) volumeChart.destroy();

                                        volumeChart = new Chart(ctx, {
                                            type: 'line',
                                            data: {
                                                labels: labels,
                                                datasets: [{
                                                    label: 'Detections per Minute',
                                                    data: values,
                                                    borderColor: '#2b7cee',
                                                    backgroundColor: 'rgba(43, 124, 238, 0.1)',
                                                    fill: true,
                                                    tension: 0.4
                                                }]
                                            },
                                            options: {
                                                responsive: true,
                                                maintainAspectRatio: false,
                                                scales: {
                                                    y: { beginAtZero: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                                                    x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                                                },
                                                plugins: {
                                                    legend: { display: false }
                                                }
                                            }
                                        });
                                    }

                                    async function fetchLog() {
                                        const { data } = await supabaseClient.from('lecturas')
                                            .select('*')
                                            .order('created_at', { ascending: false })
                                            .limit(20);

                                        if (data) {
                                            logTableBody.innerHTML = '';
                                            data.forEach(addLogRow);
                                        }
                                    }

                                    function addLogRow(lectura) {
                                        const date = new Date(lectura.created_at);
                                        const timeStr = date.toLocaleTimeString();
                                        const dateStr = date.toLocaleDateString();

                                        let colorClass = "bg-gray-500";
                                        if (lectura.color === 'ROJO') colorClass = "bg-red-500";
                                        if (lectura.color === 'VERDE') colorClass = "bg-green-500";
                                        if (lectura.color === 'AZUL') colorClass = "bg-blue-500";

                                        const row = `
            <tr class="bg-white dark:bg-[#182330] border-b dark:border-slate-800">
                <td class="px-6 py-4 flex items-center gap-2 font-medium text-slate-900 dark:text-white">
                    <span class="h-3 w-3 rounded-full ${colorClass}"></span>${lectura.color}
                </td>
                <td class="px-6 py-4">${lectura.turno}</td>
                <td class="px-6 py-4">${timeStr}</td>
                <td class="px-6 py-4">${dateStr}</td>
            </tr>
        `;
                                        logTableBody.insertAdjacentHTML('afterbegin', row);
                                        if (logTableBody.children.length > 20) {
                                            logTableBody.lastElementChild.remove();
                                        }
                                    }

                                    init();
                                </script>
                            </body>

                            </html>