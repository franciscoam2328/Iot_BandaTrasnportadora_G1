<!DOCTYPE html>
<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>UPAO - Grupo 1 - IoT - Analytics</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&amp;display=swap" rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <style>
        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }
    </style>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#2b7cee",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101822",
                    },
                    fontFamily: {
                        "display": ["Manrope"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
</head>

<body class="font-display bg-background-light dark:bg-background-dark">
    <div class="relative flex h-auto min-h-screen w-full flex-col group/design-root overflow-x-hidden">
        <div class="flex min-h-screen">
            <aside
                class="w-64 shrink-0 flex-col justify-between bg-white dark:bg-[#182330] p-4 hidden lg:flex border-r border-slate-200 dark:border-slate-800">
                <div class="flex flex-col gap-4">
                    <div class="flex items-center gap-3 p-2">
                        <div class="flex flex-col">
                            <h1 class="text-slate-900 dark:text-slate-200 text-base font-medium leading-normal">UPAO IoT
                            </h1>
                            <p class="text-slate-500 dark:text-slate-400 text-sm font-normal leading-normal">Grupo 1</p>
                        </div>
                    </div>
                    <nav class="flex flex-col gap-2 mt-4">
                        <a class="flex items-center gap-3 px-3 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800"
                            href="index.html">
                            <span class="material-symbols-outlined">dashboard</span>
                            <p class="text-sm font-medium leading-normal">Dashboard</p>
                        </a>
                        <a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/10 text-primary dark:bg-primary/20"
                            href="#">
                            <span class="material-symbols-outlined"
                                style="font-variation-settings: 'FILL' 1;">bar_chart</span>
                            <p class="text-sm font-medium leading-normal">Analytics</p>
                        </a>
                    </nav>
                </div>
            </aside>
            <main class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto">
                <div class="mx-auto max-w-7xl">
                    <div class="flex flex-wrap justify-between gap-3 p-4">
                        <div class="flex min-w-72 flex-col gap-2">
                            <h1
                                class="text-[#0d131b] dark:text-slate-100 text-3xl md:text-4xl font-black leading-tight tracking-[-0.033em]">
                                Daily Production Report
                            </h1>
                            <p class="text-[#4c6c9a] dark:text-slate-400 text-base font-normal leading-normal">
                                Review production metrics by date.
                            </p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="exportToPDF()"
                                class="flex items-center gap-2 bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                                <span class="material-symbols-outlined text-sm">picture_as_pdf</span>
                                Export PDF
                            </button>
                            <label for="date-picker"
                                class="text-sm font-medium text-slate-700 dark:text-slate-300">Date:</label>
                            <input type="date" id="date-picker"
                                class="form-input rounded-lg border-slate-300 bg-white dark:bg-[#182330] dark:border-slate-700 text-slate-900 dark:text-white">
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 p-4">
                        <div
                            class="flex flex-1 flex-col gap-2 rounded-xl p-6 border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#182330]">
                            <p class="text-slate-600 dark:text-slate-300 text-base font-medium leading-normal">Total
                                Processed</p>
                            <p id="total-products"
                                class="text-[#0d131b] dark:text-slate-100 tracking-tight text-3xl font-bold leading-tight">
                                0</p>
                        </div>
                        <div
                            class="flex flex-1 flex-col gap-2 rounded-xl p-6 border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#182330]">
                            <p class="text-slate-600 dark:text-slate-300 text-base font-medium leading-normal">Red</p>
                            <p id="total-red"
                                class="text-[#0d131b] dark:text-slate-100 tracking-tight text-3xl font-bold leading-tight">
                                0</p>
                        </div>
                        <div
                            class="flex flex-1 flex-col gap-2 rounded-xl p-6 border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#182330]">
                            <p class="text-slate-600 dark:text-slate-300 text-base font-medium leading-normal">Green</p>
                            <p id="total-green"
                                class="text-[#0d131b] dark:text-slate-100 tracking-tight text-3xl font-bold leading-tight">
                                0</p>
                        </div>
                        <div
                            class="flex flex-1 flex-col gap-2 rounded-xl p-6 border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#182330]">
                            <p class="text-slate-600 dark:text-slate-300 text-base font-medium leading-normal">Blue</p>
                            <p id="total-blue"
                                class="text-[#0d131b] dark:text-slate-100 tracking-tight text-3xl font-bold leading-tight">
                                0</p>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="grid grid-cols-1 xl:grid-cols-3 gap-4 px-4">
                        <!-- Shift Distribution -->
                        <div
                            class="xl:col-span-2 p-6 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#182330]">
                            <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Production by
                                Shift (Selected Date)</h3>
                            <div class="h-80 flex items-center justify-center relative w-full">
                                <canvas id="shiftChart"></canvas>
                            </div>
                        </div>
                        <!-- Color Breakdown -->
                        <div
                            class="p-6 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#182330]">
                            <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Color Breakdown
                            </h3>
                            <div class="h-80 flex items-center justify-center relative w-full">
                                <canvas id="breakdownChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Sessions Log Table -->
                    <div class="px-4 pt-8 pb-4">
                        <div
                            class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#182330] overflow-hidden">
                            <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-200 p-6">Sessions Log
                                (Start/End Times)</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-slate-500 dark:text-slate-400">
                                    <thead
                                        class="text-xs text-slate-700 dark:text-slate-300 uppercase bg-slate-50 dark:bg-slate-800/50">
                                        <tr>
                                            <th class="px-6 py-3">Shift</th>
                                            <th class="px-6 py-3">Start Time</th>
                                            <th class="px-6 py-3">End Time</th>
                                            <th class="px-6 py-3">Red</th>
                                            <th class="px-6 py-3">Green</th>
                                            <th class="px-6 py-3">Blue</th>
                                            <th class="px-6 py-3">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sessions-table-body">
                                        <!-- Rows injected via JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Detections Log Table -->
                    <div class="px-4 pt-4 pb-4">
                        <div
                            class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#182330] overflow-hidden">
                            <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-200 p-6">Recent Detections
                                (Selected Date)</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-slate-500 dark:text-slate-400">
                                    <thead
                                        class="text-xs text-slate-700 dark:text-slate-300 uppercase bg-slate-50 dark:bg-slate-800/50">
                                        <tr>
                                            <th class="px-6 py-3">Color</th>
                                            <th class="px-6 py-3">Shift</th>
                                            <th class="px-6 py-3">Time</th>
                                        </tr>
                                    </thead>
                                    <tbody id="log-table-body">
                                        <!-- Rows injected via JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </main>
        </div>
    </div>

    <script>
        // --- Supabase Config ---
        const SUPABASE_URL = 'https://evorufjkfqmqmjhdpxeo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2b3J1ZmprZnFtcW1qaGRweGVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3Njc1NTgsImV4cCI6MjA3OTM0MzU1OH0.ewTwn9B7cj_5ibr12UiMxxhd0sM5CTRfCF4IiepCJrI';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Elements
        const datePicker = document.getElementById('date-picker');
        const totalProductsEl = document.getElementById('total-products');
        const totalRedEl = document.getElementById('total-red');
        const totalGreenEl = document.getElementById('total-green');
        const totalBlueEl = document.getElementById('total-blue');
        const sessionsTableBody = document.getElementById('sessions-table-body');
        const logTableBody = document.getElementById('log-table-body');

        // Charts
        let breakdownChart, shiftChart;

        // Init
        async function init() {
            // Set default date to today (local time)
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            datePicker.value = `${yyyy}-${mm}-${dd}`;

            // Load initial data
            await loadDailyData();

            // Listen for date changes
            datePicker.addEventListener('change', loadDailyData);

            // Realtime subscriptions (reload if something changes today)
            supabaseClient.channel('public:sesiones')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'sesiones' }, loadDailyData)
                .subscribe();

            supabaseClient.channel('public:lecturas')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'lecturas' }, loadDailyData)
                .subscribe();
        }

        async function loadDailyData() {
            const selectedDate = datePicker.value;
            if (!selectedDate) return;

            // Define start and end of selected day (UTC)
            // Note: Supabase stores in UTC. We need to be careful with timezones.
            // For simplicity, we'll fetch range from 00:00 to 23:59 of selected date string.
            const startOfDay = new Date(selectedDate + 'T00:00:00').toISOString();
            const endOfDay = new Date(selectedDate + 'T23:59:59').toISOString();

            // 1. Fetch Sessions for this day
            const { data: sessions, error: sessError } = await supabaseClient
                .from('sesiones')
                .select('*')
                .gte('inicio', startOfDay)
                .lte('inicio', endOfDay)
                .order('inicio', { ascending: false });

            if (sessError) console.error('Error fetching sessions:', sessError);

            // 2. Fetch Readings (Lecturas) for this day (limit 50 for log)
            const { data: readings, error: readError } = await supabaseClient
                .from('lecturas')
                .select('*')
                .gte('created_at', startOfDay)
                .lte('created_at', endOfDay)
                .order('created_at', { ascending: false })
                .limit(50);

            if (readError) console.error('Error fetching readings:', readError);

            // Process Data
            renderSessionsTable(sessions || []);
            renderReadingsTable(readings || []);
            calculateAndRenderStats(sessions || []);
        }

        function renderSessionsTable(sessions) {
            sessionsTableBody.innerHTML = '';
            if (sessions.length === 0) {
                sessionsTableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center">No sessions found for this date.</td></tr>';
                return;
            }

            sessions.forEach(s => {
                const start = new Date(s.inicio).toLocaleTimeString();
                const end = s.fin ? new Date(s.fin).toLocaleTimeString() : '<span class="text-green-500 font-bold">Active</span>';
                const total = (s.total_rojo || 0) + (s.total_verde || 0) + (s.total_azul || 0);

                const row = `
                    <tr class="bg-white dark:bg-[#182330] border-b dark:border-slate-800">
                        <td class="px-6 py-4 font-medium text-slate-900 dark:text-white">${s.turno}</td>
                        <td class="px-6 py-4">${start}</td>
                        <td class="px-6 py-4">${end}</td>
                        <td class="px-6 py-4 text-red-500 font-semibold">${s.total_rojo || 0}</td>
                        <td class="px-6 py-4 text-green-500 font-semibold">${s.total_verde || 0}</td>
                        <td class="px-6 py-4 text-blue-500 font-semibold">${s.total_azul || 0}</td>
                        <td class="px-6 py-4 font-bold">${total}</td>
                    </tr>
                `;
                sessionsTableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        function renderReadingsTable(readings) {
            logTableBody.innerHTML = '';
            if (readings.length === 0) {
                logTableBody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center">No detections found for this date.</td></tr>';
                return;
            }

            readings.forEach(r => {
                const time = new Date(r.created_at).toLocaleTimeString();
                let colorClass = "bg-gray-500";
                if (r.color === 'ROJO') colorClass = "bg-red-500";
                if (r.color === 'VERDE') colorClass = "bg-green-500";
                if (r.color === 'AZUL') colorClass = "bg-blue-500";

                const row = `
                    <tr class="bg-white dark:bg-[#182330] border-b dark:border-slate-800">
                        <td class="px-6 py-4 flex items-center gap-2">
                            <span class="h-3 w-3 rounded-full ${colorClass}"></span>${r.color}
                        </td>
                        <td class="px-6 py-4">${r.turno}</td>
                        <td class="px-6 py-4">${time}</td>
                    </tr>
                `;
                logTableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        function calculateAndRenderStats(sessions) {
            // Aggregates for the day
            let totalR = 0, totalG = 0, totalB = 0;
            let shiftStats = {
                'turno1': { r: 0, g: 0, b: 0 },
                'turno2': { r: 0, g: 0, b: 0 },
                'turno3': { r: 0, g: 0, b: 0 }
            };

            sessions.forEach(s => {
                const r = s.total_rojo || 0;
                const g = s.total_verde || 0;
                const b = s.total_azul || 0;

                totalR += r;
                totalG += g;
                totalB += b;

                if (shiftStats[s.turno]) {
                    shiftStats[s.turno].r += r;
                    shiftStats[s.turno].g += g;
                    shiftStats[s.turno].b += b;
                }
            });

            // Update Cards
            totalRedEl.textContent = totalR;
            totalGreenEl.textContent = totalG;
            totalBlueEl.textContent = totalB;
            totalProductsEl.textContent = totalR + totalG + totalB;

            // Update Charts
            renderBreakdownChart(totalR, totalG, totalB);
            renderShiftChart(shiftStats);
        }

        function renderBreakdownChart(r, g, b) {
            const ctx = document.getElementById('breakdownChart').getContext('2d');
            if (breakdownChart) breakdownChart.destroy();

            breakdownChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Rojo', 'Verde', 'Azul'],
                    datasets: [{
                        data: [r, g, b],
                        backgroundColor: ['#D90429', '#00A878', '#3A86FF'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#94a3b8' } }
                    }
                }
            });
        }

        function renderShiftChart(stats) {
            const ctx = document.getElementById('shiftChart').getContext('2d');
            if (shiftChart) shiftChart.destroy();

            const labels = ['Turno 1', 'Turno 2', 'Turno 3'];
            const dataR = [stats['turno1'].r, stats['turno2'].r, stats['turno3'].r];
            const dataG = [stats['turno1'].g, stats['turno2'].g, stats['turno3'].g];
            const dataB = [stats['turno1'].b, stats['turno2'].b, stats['turno3'].b];

            shiftChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Rojo', data: dataR, backgroundColor: '#D90429' },
                        { label: 'Verde', data: dataG, backgroundColor: '#00A878' },
                        { label: 'Azul', data: dataB, backgroundColor: '#3A86FF' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                    },
                    plugins: {
                        legend: { labels: { color: '#94a3b8' } }
                    }
                }
            });
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const date = datePicker.value;

            // Title
            doc.setFontSize(18);
            doc.text(`Reporte de Producción - ${date}`, 14, 20);

            // Summary
            doc.setFontSize(12);
            doc.text(`Total Procesado: ${totalProductsEl.textContent}`, 14, 30);
            doc.text(`Rojo: ${totalRedEl.textContent}`, 14, 36);
            doc.text(`Verde: ${totalGreenEl.textContent}`, 14, 42);
            doc.text(`Azul: ${totalBlueEl.textContent}`, 14, 48);

            // Sessions Table
            doc.text("Registro de Sesiones", 14, 60);
            doc.autoTable({
                startY: 65,
                head: [['Turno', 'Inicio', 'Fin', 'Rojo', 'Verde', 'Azul', 'Total']],
                body: Array.from(sessionsTableBody.querySelectorAll('tr')).map(row => {
                    return Array.from(row.querySelectorAll('td')).map(cell => cell.innerText);
                }),
                theme: 'grid',
                headStyles: { fillColor: [43, 124, 238] }
            });

            // Detections Table
            const finalY = doc.lastAutoTable.finalY || 65;
            doc.text("Detecciones Recientes (Últimas 50)", 14, finalY + 15);
            doc.autoTable({
                startY: finalY + 20,
                head: [['Color', 'Turno', 'Hora']],
                body: Array.from(logTableBody.querySelectorAll('tr')).map(row => {
                    return Array.from(row.querySelectorAll('td')).map(cell => cell.innerText);
                }),
                theme: 'striped',
                headStyles: { fillColor: [43, 124, 238] }
            });

            // Save
            doc.save(`Reporte_Produccion_${date}.pdf`);
        }

        init();
    </script>
</body>

</html>